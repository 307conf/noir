{{- $ctx := . -}}
{{- $allowedTracks := $ctx.Site.Params.tracks -}}
{{- $agendaPages := where (where $ctx.Site.RegularPages "Section" "presentations") "Language.Lang" $ctx.Language.Lang -}}
{{- $filtered := partial "filter-presentations-by-tracks.html" (dict "Pages" $agendaPages "Tracks" $allowedTracks) -}}
{{- $agenda := sort $filtered "Date" "asc" -}}

{{ with $agenda }}
{{ $agendaCount := len . }}
<section>
    <h2 class="text-4xl font-bold mb-5">{{ T "agendaTitle" }}</h2>
    <div class="space-y-0 mx-auto">
        {{ range $index, $entry := . }}
        {{ $author := partial "presentation-author.html" . }}

        {{ $entryTracks := slice }}
        {{ with .Params.tracks }}
            {{ range . }}{{ $entryTracks = $entryTracks | append . }}{{ end }}
        {{ end }}
        {{ with .Params.track }}
            {{ $entryTracks = $entryTracks | append . }}
        {{ end }}

        {{ $spacingClasses := "" }}
        {{ if lt $index (sub $agendaCount 1) }}
            {{ $spacingClasses = "pb-6 md:pb-7 border-b border-gray-800 dark:border-gray-700" }}
        {{ end }}
        {{ $topSpacing := "" }}
        {{ if gt $index 0 }}
            {{ $topSpacing = "pt-4 md:pt-5" }}
        {{ end }}
        <div class="relative pl-8 before:content-[''] before:absolute before:left-0 before:top-0 before:w-[2px] before:h-full before:bg-gray-700 before:rounded-full {{ $spacingClasses }} {{ $topSpacing }}">
            <div class="absolute -left-1.5 top-0 w-2 h-2 bg-gray-700 rounded-full"></div>
            <div class="text-gray-400 text-xl mb-1">
                {{ if $author.Link }}
                    <a href="{{ $author.Link }}" target="_blank" rel="noopener noreferrer" class="group inline-flex items-center gap-2 font-medium hover:text-accent-light dark:hover:text-accent-dark transition-colors duration-200">
                        {{ $author.Name }}
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 group-hover:opacity-100 transition-opacity duration-200">
                            <path d="M7 17l9.2-9.2M17 17V7H7"/>
                        </svg>
                    </a>
                {{ else }}
                    {{ $author.Name }}
                {{ end }}
            </div>
            <p class="text-2xl font-semibold">{{ .Title }}</p>
            <div class="flex flex-col md:flex-row md:items-center md:gap-6 mb-2 space-y-2 md:space-y-0">
                <span class="flex items-center gap-2 py-2 pr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="opacity-90" width="16" height="16" viewBox="-7 -2 24 24"><path fill="currentColor" d="M4 9.9A5.002 5.002 0 0 1 5 0a5 5 0 0 1 1 9.9V19a1 1 0 0 1-2 0V9.9zM5 8a3 3 0 1 0 0-6a3 3 0 0 0 0 6z"/></svg>
                    <p class="text-gray-400 text-sm">{{ with .Params.location }}{{ . }}{{ end }}</p>
                </span>
                <span class="flex items-center gap-2 py-2 pr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="opacity-90" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" fill="none"></rect>
                        <path d="M16 2v4M8 2v4" stroke="currentColor"></path>
                        <path d="M3 10h18" stroke="currentColor"></path>
                        <path d="M8 14h4v4" stroke="currentColor"></path>
                    </svg>
                    <p class="text-gray-400 text-sm">{{ with .Params.period }}{{ . }}{{ else }}{{ partial "format_datetime.html" (dict "date" .Date "format" "date") }}{{ end }}</p>
                </span>
            </div>
            <!-- {{ if gt (len $entryTracks) 0 }}
            <div class="flex flex-wrap gap-2 mb-2">
                {{ range uniq $entryTracks }}
                    <span class="px-2 py-1 rounded-md bg-bg-tertiary-light dark:bg-bg-tertiary-dark text-xs text-text-secondary-light dark:text-text-secondary-dark">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }} -->
            <p class="mt-2">{{ .Params.short_description | default .Summary }}</p>
        </div>
        {{ end }}
    </div>
</section>
{{ else }}
{{ warnf "No agenda entries found for language %q. Add markdown files under content/%s/agenda/." .Language.Lang .Language.Lang }}
{{ end }}
