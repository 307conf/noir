{{- /* Returns a slice of pages filtered by allowed tracks (case-insensitive). */ -}}
{{- $pages := .Pages | default (slice) -}}
{{- $allowedRaw := .Tracks -}}

{{- /* Normalize allowed tracks */ -}}
{{- $allowed := slice -}}
{{- if $allowedRaw }}
  {{- range $allowedRaw }}
    {{- $allowed = $allowed | append (lower (printf "%v" .)) -}}
  {{- end }}
  {{- $allowed = uniq $allowed -}}
{{- end }}
{{- $allowAll := eq (len $allowed) 0 -}}

{{- $filtered := slice -}}
{{- range $pages }}
  {{- $isPlaceholder := eq true .Params.placeholder -}}
  {{- $pageTracks := slice -}}
  {{- with .Params.tracks }}
    {{- range . }}
      {{- $pageTracks = $pageTracks | append (lower (printf "%v" .)) -}}
    {{- end }}
  {{- end }}
  {{- with .Params.track }}
    {{- $pageTracks = $pageTracks | append (lower (printf "%v" .)) -}}
  {{- end }}
  {{- $pageTracks = uniq $pageTracks -}}

  {{- /* If no filter is set, or if the presentation has no track, include it. */ -}}
  {{- $matches := or $allowAll (eq (len $pageTracks) 0) $isPlaceholder -}}
  {{- if and (not $matches) (gt (len (intersect $allowed $pageTracks)) 0) }}
    {{- $matches = true -}}
  {{- end }}

  {{- if $matches }}
    {{- $filtered = $filtered | append . -}}
  {{- end }}
{{- end }}

{{- return $filtered -}}
