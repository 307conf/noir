{{- /*
Reusable table layout for listing presentations/talks.
Params:
- Pages: slice of pages to render.
- ShowTracks: bool (default true)
- ShowLocation: bool (default false)
- ShowSlides: bool (default false)
*/ -}}
{{- $pages := .Pages | default (slice) -}}
{{- $showTracks := cond (isset . "ShowTracks") .ShowTracks true -}}
{{- $showLocation := cond (isset . "ShowLocation") .ShowLocation true -}}
{{- $showSlides := cond (isset . "ShowSlides") .ShowSlides false -}}
{{- $siteCtx := .Site | default site -}}
{{- $lang := .Language | default $siteCtx.Language -}}
{{- $entries := sort $pages "Date" "asc" -}}

{{- /* Optional date filter */ -}}
{{- $dateRange := .DateRange -}} {{/* expects map with optional "Start" and "End" time values */}}
{{- /* Optional date/time format; see format_datetime.html (accepts "date", "datetime" or custom tokens like HH:mm) */ -}}
{{- $timeFormat := .TimeFormat | default "datetime" -}}

{{- /* Map track slug to village title for the current language */ -}}
{{- $trackNameMap := dict -}}
{{- $villagePages := where (where $siteCtx.Pages "Section" "villages") "Language.Lang" $lang.Lang -}}
{{- $villagePages = where $villagePages "IsNode" true -}} {{/* only section/term nodes, skip leaf talks under villages */}}
{{- range $villagePages }}
    {{- $page := . -}}
    {{- with $page.Params.track }}
        {{- $trackNameMap = merge $trackNameMap (dict (lower (printf "%v" .)) $page.Title) -}}
    {{- end }}
{{- end }}

{{- /* Apply optional date filtering */ -}}
{{- $filtered := slice -}}
{{- range $entries }}
    {{- $date := .Params.period | default .Date -}}
    {{- $inRange := true -}}
    {{- with $dateRange }}
        {{- with .Start }}{{ if lt $date . }}{{ $inRange = false }}{{ end }}{{ end }}
        {{- with .End }}{{ if gt $date . }}{{ $inRange = false }}{{ end }}{{ end }}
    {{- end }}
    {{- if $inRange }}{{ $filtered = $filtered | append . }}{{ end }}
{{- end }}

{{- if gt (len $filtered) 0 }}
<div class="overflow-hidden rounded-xl border border-border-primary-light dark:border-border-primary-dark bg-bg-primary-light dark:bg-bg-secondary-dark shadow-sm">
    <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full text-left text-sm">
            <thead class="bg-bg-secondary-light dark:bg-bg-secondary-dark">
                <tr class="text-text-secondary-light dark:text-text-secondary-dark">
                    <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[11px]">{{ T "talkTimeLabel" }}</th>
                    {{ if $showTracks }}<th class="px-4 py-3 font-semibold uppercase tracking-wide text-[11px]">{{ T "trackLabel" }}</th>{{ end }}
                    <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[11px]">{{ T "speakerLabel" }}</th>
                    <th class="px-4 py-3 font-semibold uppercase tracking-wide text-[11px]">{{ T "talkTitleLabel" }}</th>
                    {{ if $showSlides }}<th class="px-4 py-3 font-semibold uppercase tracking-wide text-[11px] text-center">{{ T "slidesLabel" | default "Slides" }}</th>{{ end }}
                    {{ if $showLocation }}<th class="px-4 py-3 font-semibold uppercase tracking-wide text-[11px]">{{ T "locationLabel" }}</th>{{ end }}
                </tr>
            </thead>
            <tbody class="divide-y divide-border-primary-light dark:divide-border-primary-dark text-text-primary-light dark:text-text-primary-dark">
                {{ range $filtered }}
                {{ $author := partial "presentation-author.html" . }}
                {{ $isPlaceholder := eq true .Params.placeholder }}
                {{ $slidesPath := .Params.slides }}
                {{ $normalizedSlides := "" }}
                {{ $hasSlides := false }}
                {{ with $slidesPath }}
                    {{ $normalizedSlides = strings.TrimPrefix "/" . }}
                    {{ $hasSlides = fileExists (printf "static/%s" $normalizedSlides) }}
                {{ end }}
                {{ $entryTracks := slice }}
                {{ with .Params.tracks }}
                    {{ range . }}
                        {{ $slug := lower (printf "%v" .) }}
                        {{ $name := or (index $trackNameMap $slug) . }}
                        {{ $entryTracks = $entryTracks | append $name }}
                    {{ end }}
                {{ end }}
                {{ with .Params.track }}
                    {{ $slug := lower (printf "%v" .) }}
                    {{ $name := or (index $trackNameMap $slug) . }}
                    {{ $entryTracks = $entryTracks | append $name }}
                {{ end }}
                {{/* Determine display time respecting TimeFormat and possible period types */}}
                {{ $displayTime := "" }}
                {{ with .Params.period }}
                    {{ if (in (printf "%T" .) "Time") }}
                        {{ $displayTime = partial "format_datetime.html" (dict "date" . "format" $timeFormat) }}
                    {{ else }}
                        {{ $displayTime = . }}
                    {{ end }}
                {{ else }}
                    {{ $displayTime = partial "format_datetime.html" (dict "date" .Date "format" $timeFormat) }}
                {{ end }}
                <tr class="hover:bg-bg-secondary-light/60 dark:hover:bg-bg-secondary-dark/60 transition-colors duration-150">
                    <td class="px-4 py-3 whitespace-nowrap align-top text-sm text-text-secondary-light dark:text-text-secondary-dark">{{ $displayTime }}</td>
                    {{ if $showTracks }}
                    <td class="px-4 py-3 align-top">
                        {{ if gt (len $entryTracks) 0 }}
                        <div class="flex flex-wrap gap-2">
                            {{ range uniq $entryTracks }}
                                <span class="px-2 py-1 rounded-md bg-bg-tertiary-light dark:bg-bg-tertiary-dark text-[11px] font-semibold uppercase tracking-wide text-text-secondary-light dark:text-text-secondary-dark">{{ . }}</span>
                            {{ end }}
                        </div>
                        {{ end }}
                    </td>
                    {{ end }}
                    <td class="px-4 py-3 align-top text-sm text-text-secondary-light dark:text-text-secondary-dark">
                        {{ if gt (len $author.Items) 0 }}
                            {{ range $i, $a := $author.Items }}
                                {{ if $i }}, {{ end }}
                                {{ if and $a.Link (not $isPlaceholder) }}
                                    <a href="{{ $a.Link }}" class="inline-flex items-center gap-1 font-semibold hover:text-accent-light text-cyan-300 dark:hover:text-accent-dark transition-colors duration-200">
                                        {{ $a.Name }}
                                    </a>
                                {{ else }}
                                    {{ $a.Name }}
                                {{ end }}
                            {{ end }}
                        {{ else }}
                            {{ $author.Name }}
                        {{ end }}
                    </td>
                    <td class="px-4 py-3 align-top">
                        {{ if $isPlaceholder }}
                            <span class="font-semibold text-text-primary-light tracking-[0.3em] text-cyan-600 dark:text-text-primary-dark">{{ .Title }}</span>
                        {{ else }}
                            <a href="{{ .RelPermalink }}" class="font-semibold hover:text-accent-light  text-cyan-300 dark:hover:text-accent-dark transition-colors duration-200">{{ .Title }}</a>
                        {{ end }}
                        <div class="text-xs text-text-secondary-light dark:text-text-secondary-dark mt-1 line-clamp-2">{{ .Params.short_description | default .Summary }}</div>
                    </td>
                    {{ if $showSlides }}
                    <td class="px-4 py-3 align-top text-sm text-center">
                        {{ if and $slidesPath $hasSlides }}
                            <a href="{{ $slidesPath }}" class="inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 px-3 py-2 text-[11px] font-semibold uppercase tracking-wide text-white shadow-sm hover:from-emerald-400 hover:to-cyan-400 transition-all duration-150" target="_blank" rel="noopener noreferrer" aria-label='{{ T "viewSlides" | default "View slides" }}'>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <path d="M14 2v6h6"/>
                                    <path d="M12 18v-6m-3 3h6"/>
                                </svg>
                            </a>
                        {{ else }}
                            <span class="inline-flex items-center justify-center rounded-lg border border-border-primary-light dark:border-border-primary-dark bg-bg-tertiary-light dark:bg-bg-tertiary-dark px-3 py-2 text-[11px] font-semibold uppercase tracking-wide text-text-secondary-light dark:text-text-secondary-dark opacity-70 cursor-not-allowed select-none" aria-disabled="true" aria-label='{{ T "slidesUnavailable" | default "Unavailable" }}'>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <path d="M14 2v6h6"/>
                                    <path d="M9 14h6"/>
                                </svg>
                            </span>
                        {{ end }}
                    </td>
                    {{ end }}
                    {{ if $showLocation }}
                    <td class="px-4 py-3 align-top text-sm text-text-secondary-light dark:text-text-secondary-dark">{{ with .Params.location }}{{ . }}{{ end }}</td>
                    {{ end }}
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>

    <!-- Mobile stacked list -->
    <div class="md:hidden divide-y divide-border-primary-light dark:divide-border-primary-dark">
        {{ range $filtered }}
        {{ $author := partial "presentation-author.html" . }}
        {{ $isPlaceholder := eq true .Params.placeholder }}
        {{ $slidesPath := .Params.slides }}
        {{ $normalizedSlides := "" }}
        {{ $hasSlides := false }}
        {{ with $slidesPath }}
            {{ $normalizedSlides = strings.TrimPrefix "/" . }}
            {{ $hasSlides = fileExists (printf "static/%s" $normalizedSlides) }}
        {{ end }}
        {{ $entryTracks := slice }}
        {{ with .Params.tracks }}
            {{ range . }}
                {{ $slug := lower (printf "%v" .) }}
                {{ $name := or (index $trackNameMap $slug) . }}
                {{ $entryTracks = $entryTracks | append $name }}
            {{ end }}
        {{ end }}
        {{ with .Params.track }}
            {{ $slug := lower (printf "%v" .) }}
            {{ $name := or (index $trackNameMap $slug) . }}
            {{ $entryTracks = $entryTracks | append $name }}
        {{ end }}
        {{ $displayTime := "" }}
        {{ with .Params.period }}
            {{ if (in (printf "%T" .) "Time") }}
                {{ $displayTime = partial "format_datetime.html" (dict "date" . "format" $timeFormat) }}
            {{ else }}
                {{ $displayTime = . }}
            {{ end }}
        {{ else }}
            {{ $displayTime = partial "format_datetime.html" (dict "date" .Date "format" $timeFormat) }}
        {{ end }}
        <div class="p-4">
            <div class="text-xs uppercase tracking-wide text-text-secondary-light dark:text-text-secondary-dark mb-1">{{ $displayTime }}</div>
            {{ if $isPlaceholder }}
                <span class="text-lg font-semibold text-text-primary-light dark:text-text-primary-dark">{{ .Title }}</span>
            {{ else }}
                <a href="{{ .RelPermalink }}" class="text-lg font-semibold text-text-primary-light dark:text-text-primary-dark hover:text-accent-light dark:hover:text-accent-dark transition-colors duration-200">{{ .Title }}</a>
            {{ end }}
            <div class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">
                {{ if gt (len $author.Items) 0 }}
                    {{ range $i, $a := $author.Items }}
                        {{ if $i }}, {{ end }}
                        {{ if and $a.Link (not $isPlaceholder) }}
                            <a href="{{ $a.Link }}" class="inline-flex items-center gap-1 font-semibold hover:text-accent-light dark:hover:text-accent-dark transition-colors duration-200">
                                {{ $a.Name }}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17l9.2-9.2M17 17V7H7"/></svg>
                            </a>
                        {{ else }}
                            {{ $a.Name }}
                        {{ end }}
                    {{ end }}
                {{ else }}
                    {{ $author.Name }}
                {{ end }}
            </div>
            {{ if gt (len $entryTracks) 0 }}
            <div class="flex flex-wrap gap-2 mt-2">
                {{ range uniq $entryTracks }}
                    <span class="px-2 py-1 rounded-md bg-bg-tertiary-light dark:bg-bg-tertiary-dark text-[11px] font-semibold uppercase tracking-wide text-text-secondary-light dark:text-text-secondary-dark">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }}
            {{ if $showLocation }}
            <div class="mt-2 text-sm text-text-secondary-light dark:text-text-secondary-dark">{{ with .Params.location }}{{ . }}{{ end }}</div>
            {{ end }}
            {{ if $showSlides }}
            <div class="mt-3">
                {{ if and $slidesPath $hasSlides }}
                    <a href="{{ $slidesPath }}" class="inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-emerald-500 to-cyan-500 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-white shadow-sm hover:from-emerald-400 hover:to-cyan-400 transition-all duration-150" target="_blank" rel="noopener noreferrer" aria-label='{{ T "viewSlides" | default "View slides" }}'>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <path d="M12 18v-6m-3 3h6"/>
                        </svg>
                    </a>
                {{ else }}
                    <span class="inline-flex items-center justify-center rounded-lg border border-border-primary-light dark:border-border-primary-dark bg-bg-tertiary-light dark:bg-bg-tertiary-dark px-3 py-2 text-xs font-semibold uppercase tracking-wide text-text-secondary-light dark:text-text-secondary-dark opacity-70 cursor-not-allowed select-none" aria-disabled="true" aria-label='{{ T "slidesUnavailable" | default "Unavailable" }}'>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <path d="M9 14h6"/>
                        </svg>
                    </span>
                {{ end }}
            </div>
            {{ end }}
            <div class="mt-2 text-sm text-text-secondary-light dark:text-text-secondary-dark line-clamp-3">{{ .Summary | default .Params.short_description }}</div>
        </div>
        {{ end }}
    </div>
</div>
{{ else }}
    <p class="text-text-secondary-light dark:text-text-secondary-dark">{{ T "noEntriesYet" | default "Entries coming soon." }}</p>
{{ end }}
